# brAInwav Waiver Playbook — 40-Line Streaming Handlers

## Scope
Applies when contributors request relief from the `max-lines-per-function` (40 line) lint enforced by `.eslintrc.cjs` for streaming or long-running handlers.

## Evaluation Checklist
1. **Gather context** — Confirm the handler’s contract, inputs/outputs, and async cancellation path. Require code snippets and trace logs demonstrating streaming boundaries.
2. **Refactoring options** — Identify helper extractions (parsing, transport orchestration, telemetry) before entertaining a waiver. Document each alternative and why it fails (performance, shared state, or transactional semantics).
3. **Automation alignment** — Cite the blocking lint (`max-lines-per-function`) and any relevant Semgrep rule IDs from [`semgrep/brAInwav.yml`](../../semgrep/brAInwav.yml) that cover AbortSignal enforcement (`brainwav.async.fetch-*`, `brainwav.async.axios-*`).
4. **Testing evidence** — Require unit/integration coverage for backpressure, cancellation, and error propagation. Attach failing tests or benchmarks when refactors regress behaviour.
5. **Temporary controls** — If a waiver is granted, mandate:
   - Additional structured logging with `{ brand: 'brAInwav', component: '<module>' }` context.
   - Explicit `AbortController` wiring verified by the new Semgrep rules.
   - Issue tracker follow-up to revisit decomposition (target date ≤ 2 sprints).
6. **Approval workflow** — File `/.cortex/waivers/<waiver_id>.md` including scope, `approved_by` metadata (one or more Maintainers), `expires` (≤ 30 days), mitigation steps, and links to CODESTYLE Appendix B.

## Automated Policy Gate

- CI renders every waiver Markdown/YAML file to `reports/waivers.json` using `pnpm waivers:json`. The generator parses front matter, normalises timestamps, and persists a machine-readable ledger for policy enforcement.
- The **Agents Governance** workflow now installs Conftest and evaluates `.cortex/policy/waivers.rego` with `conftest test -p .cortex/policy --all-namespaces reports/waivers.json`. The policy denies:
  - entries without `approved_by` metadata;
  - approvals lacking a Maintainer role;
  - missing `expires` timestamps or invalid ISO-8601 values; and
  - waivers whose expiry is more than 30 days after their recorded `created_at`.
- Remediate failures by updating the waiver front matter (ensure a Maintainer is listed, tighten the expiry window, and backfill `created_at`/`expires` pairs generated by `pnpm waivers:json`). Re-run `pnpm waivers:json -- --skip-snapshot` locally, followed by `conftest test -p .cortex/policy reports/waivers.json`, before pushing fixes.
- Keep metadata in the YAML front matter at the top of each waiver file so the converter can extract it. Example:

  ```yaml
  ---
  waiver_id: streaming-handler-20250101
  rule_ids:
    - eslint/max-lines-per-function
  owner: team-observability
  approved_by:
    - name: Jamie Maintainer
      role: Maintainer
    - name: Casey Reviewer
      roles:
        - Reviewer
        - Maintainer
  expires: 2025-01-31T23:59:59Z
  mitigations:
    - Added structured logging with { brand: 'brAInwav' }
    - Backpressure integration test `streaming-handler.backpressure.spec.ts`
  reason: Streaming handler must batch transcripts during incident swarms.
  ---
  ```

- **Local validation:** Run `pnpm waivers:json` before committing. The generator enforces the waiver JSON schema (Maintainer approval, ISO-8601 expirations) and emits summary metrics under `reports/waivers.json` plus timestamped snapshots in `reports/waivers-history/`.
- **Regression guard:** `pnpm waivers:test` generates fixture payloads and executes `conftest test -p policy/opa --all-namespaces …` so policy regressions (e.g., >30 day expirations or missing Maintainers) fail locally before CI.
- **CI caching:** The governance workflow caches the signed Conftest binary per version/OS to avoid repeated downloads while still verifying upstream checksums on cache misses.

## Request Workflow

Use the CLI to record waivers so the governance bots can track provenance and expiry:

```bash
pnpm charter:waiver \
  --request.id streaming-handler-20250101 \
  --request.rule_ids eslint/max-lines-per-function \
  --request.owner jane.doe \
  --request.approver maintainer.team \
  --request.expiry 2025-01-31 \
  --request.reason "Streaming handler requires additional instrumentation before refactor"
```

- The command writes YAML to `/.cortex/waivers/<id>.yaml` with `created_at` and normalized ISO `expiry` timestamps.
- Pass comma-separated values or repeat `--request.rule_ids[]` to document multiple rules.
- Provide `--request.mitigations[]` flags to enumerate compensating controls.

## Review Cadence
- Revalidate waivers each sprint during the governance review.
- Archive expired waivers under `.cortex/waivers/archive/` with outcome notes.
- Escalate to Maintainer if more than two active streaming-handler waivers exist concurrently.

## Ledger & Rotation
- Every approval recorded via the **Apply Waiver** GitHub workflow writes an immutable row to `.cortex/audit/waivers.jsonl` capturing the waiver ID, linked PR, approver, timestamps, and workflow metadata.
- Use `node scripts/governance/waiver-ledger.mjs report --ledger .cortex/audit/waivers.jsonl --warn-days 7 --format markdown` to review upcoming expirations (also surfaced automatically in the scheduled `waiver-ledger-audit` workflow).
- When a waiver is remediated:
  1. Update the Markdown record under `/.cortex/waivers/<id>.md` with `status: closed` and a `closed_at` timestamp, then move it into `/.cortex/waivers/archive/`.
  2. Append a closure note to the ledger by re-running `node scripts/governance/waiver-ledger.mjs append --ledger .cortex/audit/waivers.jsonl --waiver-id <id> --pr-number <pr> --approver <approver> --note "closed <ISO8601>" --allow-duplicate --actor $(git config user.name)` to preserve an audit trail.
  3. Confirm the Monday `waiver-ledger-audit` summary reports no lingering expired waivers; if entries persist, investigate missing archive steps or outstanding mitigations.

> **Tip:** Repository variable `WAIVER_TRACKER_ISSUE` points the scheduled workflow at the governance tracking issue; secrets `SLACK_WEBHOOK_WAIVERS` (optional) receive the same summary for ops visibility.

## Waiver Template Fields
| Field | Description |
| --- | --- |
| `waiver_id` | Unique slug (e.g., `streaming-handler-<yyyymmdd>`). |
| `rule_ids` | `eslint/max-lines-per-function` + any Semgrep async rule triggered. |
| `owner` | Code owner accountable for remediation. |
| `approved_by` | Single object or array that contains at least one Maintainer approval. |
| `expires` | ISO-8601 timestamp (≤ 30 days out). |
| `mitigations` | Logs/tests/monitoring deployed while waiver active. |

## Revocation Triggers
- Missing logs or failing cancellation tests.
- Semgrep hits for AbortSignal omissions inside the waived handler.
- Missed expiry without approved extension.
