metadata:
  schemaVersion: https://cortex-os.brainwav.dev/schemas/agentic.core.schema.json
  packVersion: 0.1.0
  generatedAt: ${generatedAt}
  sourceShas: {}
workflow:
  phases:
    - id: R
      name: Ready
      description: Plan and preflight
    - id: G
      name: Green
      description: Implement under guardrails
    - id: F
      name: Finish
      description: Stabilise and verify
    - id: REVIEW
      name: Review
      description: Human review and signoff
  gates:
    - id: G0
      name: Initialize
      summary: Classify task, create folder, capture metadata + tier.
      phase: R
    - id: G1
      name: Discover / Research
      summary: Understand existing behaviour, dependencies, academic context.
      phase: R
    - id: G2
      name: Plan / Design
      summary: Produce PLAN.md, risk register, and assurance-validated approach.
      phase: R
    - id: G3
      name: Scaffold
      summary: Establish failing tests, feature flags, contracts, and wiring.
      phase: G
    - id: G4
      name: Implement
      summary: Execute plan (≤7 steps per arc) with TDD micro-loops.
      phase: G
    - id: G5
      name: Verify
      summary: Run tests, security/a11y/perf checks, gather Evidence Triplet.
      phase: F
    - id: G6
      name: Review
      summary: AI reviewer + human reviewer dispositions, waiver handling.
      phase: F
    - id: G7
      name: Document
      summary: Update docs, changelog, runbooks, arc manifests.
      phase: F
    - id: G8
      name: Ship
      summary: Deploy & flag management with rollback paths.
      phase: REVIEW
    - id: G9
      name: Monitor
      summary: Observe telemetry, model health, error budgets.
      phase: REVIEW
    - id: G10
      name: Archive
      summary: Preserve artefacts, update memory, close task.
      phase: REVIEW
  flows:
    - id: feature
      summary: Requires North-Star test + assurance/oversight at G2 and G5 (Aegis or project-equivalent).
      phases: [R, G, F]
      gates: [G0, G1, G2, G3, G4, G5, G6, G7]
      gatesOptional: [G8, G9, G10]
    - id: research
      summary: Produces decision memo; code optional; assurance/oversight validates sources/time freshness.
      phases: [R, G]
      gates: [G0, G1, G2, G3]
      gatesOptional: [G10]
    - id: fix
      summary: Needs reproducer, failing test, and postmortem if SEV ≥ 2.
      phases: [R, G, F]
      gates: [G0, G1, G2, G3, G4, G5, G6, G7]
      gatesOptional: [G8, G9, G10]
    - id: refactor
      summary: Behaviour-preserving; emphasise invariants + perf baselines.
      phases: [R, G, F]
      gates: [G0, G1, G2, G3, G4, G5, G6, G7]
      gatesOptional: [G10]
    - id: review
      summary: No authoring; consumes Evidence Triplet + manifests.
      phases: [F, REVIEW]
      gates: [G5, G6, G7, G10]
      gatesOptional: []
  transitions:
    - from: R
      to: G
      requirements:
        - New acceptance/unit tests **fail first**, then **pass** on the next commit
        - "`TIME_FRESHNESS:OK tz=<IANA> today=<YYYY-MM-DD>` token present"
        - Oversight log present at ${vibeCheckLogPath}
        - Threat model + data classification updated against OWASP ASVS/LLM Top 10 and NIST SSDF controls
    - from: G
      to: F
      requirements:
        - "`${pkgManager} test` **passes**"
        - Coverage ≥ **${coverageGlobal}%** global & **${coverageChanged}%** changed lines
        - Mutation ≥ **${mutationGlobal}%** (where enabled)
        - Latest model-health log recorded at ${modelsHealthLogPath}
        - SBOM + provenance artifacts generated at ${sbomSpec}/${slsaLevel} (or stricter project default) and attached to the task folder
    - from: F
      to: REVIEW
      requirements:
        - A11y reports attached
        - Security scanners clean (${securityScanners})
        - Structure validation passes
        - Models health & smoke evidence attached (live only)
        - Local memory parity entry appended
limits:
  stepBudget: ${stepBudget}
  askFirst: ${askFirst}
evidence:
  tripletRequired: ${tripletRequired}
  runManifestRequired: ${runManifestRequired}
  requiredTokens: ${evidenceTokens}
qualityGates:
  coverage:
    global: ${coverageGlobal}
    changedLines: ${coverageChanged}
  mutation:
    global: ${mutationGlobal}
  a11y:
    standard: ${a11yStandard}
  securityScanners: ${securityScanners}
  supplyChain:
    sbom: ${sbomSpec}
    slsa: ${slsaLevel}
    signing: ${signingSpec}
governance:
  precedence: ${precedenceDocs}
  hashIndexPath: ${hashIndexPath}
  requireHashVerification: ${requireHashVerification}
operationalPlaybooks:
  rollout:
    summary: "Profile rollout playbook (Q1)."
    steps:
      - "Map teams/services to a profile with an assigned DRI and record in the rollout brief."
      - "Publish a one-page brief linking to this pack; acknowledge receipt from all teams."
      - "Pilot one greenfield and one brownfield service; tag chosen profile in PR/task templates."
      - "Add CI or template reminders for profile selection; schedule a retro after two sprints."
  metrics:
    summary: "Quality/flow metrics by profile (Q2)."
    steps:
      - "Slice CI results by profile and gate; report coverage/mutation on changed lines and Evidence Triplet completeness."
      - "Track waiver volume/reasons with expiry + mitigation; monitor lead time and post-merge defect rate."
      - "For brownfield, publish weekly uplift deltas on touched code (coverage/mutation)."
  mixedSurfaces:
    summary: "Mixed regulated/consumer surfaces (Q3)."
    steps:
      - "Apply the strictest profile when regulated/data-sensitive code is touched; require profile + data-class tags in PRs."
      - "Document compensating controls with expiry in the risk register; use feature flags/shadow traffic where needed."
      - "Ensure cross-surface regression tests and observability cover regulated vs. consumer paths."
  standards:
    summary: "Standards upkeep (Q4)."
    steps:
      - "Run a quarterly standards review (SLSA, CycloneDX, WCAG, NIST/ISO/OWASP) with assigned DRIs and a watchlist."
      - "Version profiles with change logs and effective dates; communicate migrations and waivers."
      - "Keep CI/template drift checks between templates and dist outputs; document exceptions."
  training:
    summary: "Onboarding and reinforcement (Q5)."
    steps:
      - "Publish a 10-minute onboarding guide + crib sheet in PR/task templates; record a short demo."
      - "Include a profile rehearsal exercise for new joiners with reviewer sign-off."
      - "Collect feedback after two weeks and iterate the materials."
profiles:
  greenfield:
    overrides:
      description: >
        Default strict profile for net-new services. Uses the full gate set, default coverage/mutation/a11y targets,
        live model health checks, and requires SBOM + signed provenance and WCAG ${a11yStandard} evidence.
      requiredGates: [G0, G1, G2, G3, G4, G5, G6, G7]
      requiredStandards:
        - "NIST SSDF v1.1 (secure-by-default development)"
        - "ISO/IEC 42001:2023 AI management and transparency"
        - "OWASP ASVS 4.0 L2 + OWASP LLM Top 10 mitigations"
        - "WCAG ${a11yStandard} for all user-impacting changes"
      qualityGates:
        coverage:
          global: ${coverageGlobal}
          changedLines: ${coverageChanged}
        mutation:
          global: ${mutationGlobal}
      supplyChain:
        sbom: ${sbomSpec}
        slsa: ${slsaLevel}
        signing: ${signingSpec}
  brownfield:
    overrides:
      description: >
        Transitional profile for existing/legacy systems. Prioritises rigor on changed code while staging uplift for
        untouched modules and enforcing compensating controls (feature flags, dark deploys, observability baselines).
      requiredGates: [G0, G1, G2, G3, G4, G5, G6]
      stagedControls:
        - "Changed code meets ≥${coverageChanged}% coverage and ≥${mutationGlobal}% mutation; legacy surfaces get uplift backlogs with due dates."
        - "Document risk register entries for gaps with explicit expiry/owners; waivers must reference mitigation evidence."
        - "Enable runtime guards (feature flags, traffic shadowing, replay tests) before rollout."
  regulated:
    overrides:
      description: >
        High-assurance profile for regulated or safety-critical workloads (finance, health, safety, education, civic).
        Adds privacy, safety, and release controls with mandatory human sign-off.
      requiredGates: [G0, G1, G2, G3, G4, G5, G6, G7, G8, G9, G10]
      requiredStandards:
        - "NIST SSDF v1.1 + NIST AI RMF v1.0"
        - "ISO/IEC 27001:2022 controls mapped to delivery"
        - "ISO/IEC 42001:2023 governance + transparency statements"
        - "OWASP ASVS 4.0 L2/L3 + OWASP LLM Top 10"
        - "WCAG ${a11yStandard} with assistive tech validation"
      additionalEvidence:
        - "Data protection impact assessment (DPIA) and privacy review where personal data is processed."
        - "Signed SBOM (${sbomSpec}) + provenance (${slsaLevel}) for every release artifact."
        - "Model-health, bias, and safety evaluations recorded alongside the Evidence Triplet."
