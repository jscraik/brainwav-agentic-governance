name: Release

on:
  workflow_dispatch:
  push:
    tags:
      - "v0.*.*"

permissions:
  contents: write
  id-token: write
  attestations: write

env:
  NODE_VERSION: "24.11.0"
  PNPM_VERSION: "10.26.0"
  NPM_VERSION: "11.5.1"
  GO_VERSION: "1.25.5"
  SEMGREP_VERSION: "1.146.0"
  GITLEAKS_VERSION: "8.30.0"
  OSV_SCANNER_VERSION: "1.9.2"
  TRIVY_VERSION: "0.68.2"
  MARKDOWNLINT_VERSION: "0.20.0"
  COSIGN_VERSION: "v3.0.3"
  CYCLONEDX_NPM_VERSION: "4.1.2"
  NPM_ACCESS: "restricted"

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
      - uses: pnpm/action-setup@41ff72655975bd51cab0327fa583b6e92b6d3061 # v4.2.0
        with:
          version: ${{ env.PNPM_VERSION }}
      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "pnpm"
          registry-url: "https://registry.npmjs.org"
      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version: ${{ env.GO_VERSION }}
      - name: Install toolchain for doctor
        run: |
          sudo apt-get update
          sudo apt-get install -y ripgrep fd-find jq python3-pip curl unzip
          sudo ln -sf /usr/bin/fdfind /usr/local/bin/fd
          python3 -m pip install --user semgrep==${SEMGREP_VERSION}
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"
          go install github.com/zricethezav/gitleaks/v8@v${GITLEAKS_VERSION}
          go install github.com/google/osv-scanner/cmd/osv-scanner@v${OSV_SCANNER_VERSION}
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin v${TRIVY_VERSION}
          npm install -g markdownlint-cli2@${MARKDOWNLINT_VERSION}
      - name: Pin npm CLI
        run: npm install -g npm@${{ env.NPM_VERSION }}
      - name: Install cosign
        uses: sigstore/cosign-installer@faadad0cce49287aee09b3a48701e75088a2c6ad # v4.0.0
        with:
          cosign-release: ${{ env.COSIGN_VERSION }}
      - run: pnpm install --frozen-lockfile
      - name: Lint
        run: pnpm lint:ci
      - name: CLI tests
        run: pnpm test:cli
      - name: Fixture tests
        run: pnpm test:fixtures
      - name: Generate pack docs
        run: pnpm docs:generate-packs
      - name: Verify pack docs are committed
        run: git diff --exit-code docs/packs.md
      - name: Pack release artifact
        run: |
          mkdir -p dist
          npm pack --pack-destination dist
      - name: SBOM (CycloneDX)
        run: |
          npx @cyclonedx/cyclonedx-npm@${CYCLONEDX_NPM_VERSION} \
            --ignore-npm-errors \
            --output-format JSON \
            --output-file dist/sbom.cdx.json
      - name: Build provenance
        uses: actions/attest-build-provenance@977bb373ede98d70efdf65b84cb5f73e068dcc2a # v3.0.0
        with:
          subject-path: |
            dist/*.tgz
            dist/sbom.cdx.json
      - name: Sign artifacts (cosign)
        env:
          COSIGN_EXPERIMENTAL: "1"
        run: |
          for artifact in dist/*.tgz dist/*.json; do
            if [ -f "$artifact" ]; then
              cosign sign-blob --yes \
                --bundle "${artifact}.sigstore.json" \
                "$artifact"
            fi
          done
      - name: Create draft GitHub Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          draft: true
          files: dist/*
          generate_release_notes: true
      - name: Publish to npm (no provenance for private packages)
        env:
          NPM_CONFIG_PROVENANCE: "false"
        run: npm publish ./dist/*.tgz --access ${NPM_ACCESS} --registry https://registry.npmjs.org/
      - name: Checkout canary repo
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1
        with:
          repository: jscraik/brainwav-governance-canary
          token: ${{ secrets.GH_CANARY_TOKEN }}
          path: /tmp/brainwav-governance-canary
      - name: Canary validation
        env:
          RELEASE_VERSION: ${{ github.ref_name }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          version="${RELEASE_VERSION#v}"
          cd /tmp/brainwav-governance-canary
          npmrc="${RUNNER_TEMP}/.npmrc"
          echo "//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}" > "${npmrc}"
          echo "always-auth=true" >> "${npmrc}"
          export NPM_CONFIG_USERCONFIG="${npmrc}"
          pnpm add -D "@brainwav/brainwav-agentic-governance@${version}"
          pnpm exec brainwav-governance install --root . --mode pointer --profile core --yes
          pnpm exec brainwav-governance validate --root . --strict
      - name: Publish GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release edit "${{ github.ref_name }}" --draft=false
