#!/usr/bin/env node
/**
 * @fileoverview Generate .agentic-governance/agent-context.json with governance hashes and workflow pointers.
 * @module scripts/cortex-governance-bootstrap
 * @license Apache-2.0
 *
 * This script creates the agent context file required for governance-aware operation.
 * It computes SHA-256 hashes of AGENTS.md and provides workflow pointers to the
 * canonical agentic-coding-workflow.md sections.
 *
 * @example
 * // Run via npm script
 * pnpm cortex:governance-bootstrap
 *
 * @example
 * // Run directly
 * node scripts/cortex-governance-bootstrap.mjs
 */
import { createHash } from 'node:crypto';
import fs from 'node:fs';
import path from 'node:path';
import process from 'node:process';
import { fileURLToPath } from 'node:url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
const repoRoot = path.resolve(__dirname, '..');
const agentsPath = path.join(repoRoot, 'AGENTS.md');
const governanceIndexPath = path.join(repoRoot, 'brainwav/governance/90-infra/governance-index.json');
const outDir = path.join(repoRoot, '.agentic-governance');
const outFile = path.join(outDir, 'agent-context.json');

/**
 * Workflow type to section anchor mapping.
 * Each entry points to the corresponding section in agentic-coding-workflow.md.
 * @type {Record<string, string>}
 */
const workflows = {
	feature: 'brainwav/governance/10-flow/agentic-coding-workflow.md#51-feature-implementation-flow',
	fix: 'brainwav/governance/10-flow/agentic-coding-workflow.md#53-fix-implementation-flow',
	refactor: 'brainwav/governance/10-flow/agentic-coding-workflow.md#54-refactor--cleanup-flow',
	research: 'brainwav/governance/10-flow/agentic-coding-workflow.md#52-research--spike-flow',
	code_review: 'brainwav/governance/10-flow/agentic-coding-workflow.md#55-code-review-flow'
};

/**
 * Compute SHA-256 hash of a file.
 * @param {string} filePath - Absolute path to the file.
 * @returns {string} Hexadecimal SHA-256 digest.
 */
function sha256(filePath) {
	const data = fs.readFileSync(filePath);
	return createHash('sha256').update(data).digest('hex');
}

/**
 * Main entry point. Generates the agent context JSON file.
 * Sets process.exitCode = 1 if required files are missing.
 * @returns {void}
 */
function main() {
	if (!fs.existsSync(agentsPath)) {
		console.error('[brAInwav] AGENTS.md not found; cannot bootstrap.');
		process.exitCode = 1;
		return;
	}
	if (!fs.existsSync(governanceIndexPath)) {
		console.error('[brAInwav] governance-index.json not found; cannot bootstrap.');
		process.exitCode = 1;
		return;
	}

	fs.mkdirSync(outDir, { recursive: true });

	const agentsSha = sha256(agentsPath);
	const governanceIndex = JSON.parse(fs.readFileSync(governanceIndexPath, 'utf8'));

	const context = {
		repo_root: repoRoot,
		agents_md_path: agentsPath,
		agents_md_sha: agentsSha,
		governance_index_path: governanceIndexPath,
		governance_index_version: governanceIndex.version,
		workflows,
		generated_at: new Date().toISOString(),
		meta: {
			brand: 'brAInwav',
			note: 'Generated by cortex:governance-bootstrap; rerun when governance docs change.'
		}
	};

	fs.writeFileSync(outFile, `${JSON.stringify(context, null, 2)}\n`);
	console.log(`[brAInwav] cortex-governance-bootstrap wrote ${outFile}`);
	console.log(`[brAInwav] AGENTS.md sha256=${agentsSha}`);
}

if (import.meta.url === `file://${process.argv[1]}` || process.argv[1]?.endsWith('cortex-governance-bootstrap.mjs')) {
	main();
}

export default main;
